<?php
    function orderColumn($columnName) {
        $currentURL = URL::current();
        $queryString = array( 'filter' => Input::get('filter'), 'column' => $columnName );

        if ( $columnName == Input::get('column') ) {
            if ( Input::get('sort') == 'DESC') {
                $queryString['sort'] = 'ASC';
            } else {
                $queryString['sort'] = 'DESC';
            }
        } else {
            $queryString['sort'] = 'DESC';
        }

        return $currentURL . '?' . http_build_query($queryString);
    }
?>

<?php $__env->startSection('header'); ?>
    <!--<h1><?php echo $collection->name; ?></h1>-->
    <h1>Manage domains</h1>
<?php $__env->stopSection(); ?>

<?php $__env->startSection('js'); ?>
    <style> table thead .cursor{ cursor: pointer; }</style>
    <script>

        var nodeToPublish = null;

        $('.open-publish-node-modal').on('click', function(e) {
            e.preventDefault();

            nodeToPublish = $(this);

            $('#nodePublishModal').modal('show');
        });

        $('#publishNodeConfirm').on('click', function(e) {

            e.preventDefault();

            window.location = nodeToPublish.attr('href');

        });

        $('#openNodeModal').on('click', function(e) {
            e.preventDefault();

            <?php if(Route::currentRouteName() == 'nodes.type-list'): ?>
                <?php /* take them straight there! */ ?>
                var url = "<?php echo route('nodes.create', array($collection->application_id, $collection->id, $nodeType->id)); ?>";

                window.location = url;

            <?php else: ?>
                $('#addNodeModal').modal('show');
            <?php endif; ?>
        });

        $('#addNodeConfirm').on('click', function(e) {

            var nodeType = $('#node_type_select').val();

            var url = "<?php echo route('nodes.create', array($collection->application_id, $collection->id)); ?>/" + nodeType;

            window.location = url;

        });
    </script>
<?php $__env->stopSection(); ?>

<?php $__env->startSection('body'); ?>

    <form class="form-inline pull-left">
        <?php if(Route::currentRouteName() !== 'nodes.type-list'): ?>
            <div class="btn-group change-collection">
                <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
                    <?php if(Input::get('filter')): ?>
                        <?php echo $nodeTypes[Input::get('filter')]; ?>

                    <?php else: ?>
                        Filter by Node Type
                    <?php endif; ?>
                    <span class="caret"></span>
                </a>
                <ul class="dropdown-menu pull-right">
                    <?php foreach($nodeTypes as $id => $nodeType): ?>
                        <li><a href="?filter=<?php echo $id; ?>"><?php echo $nodeType; ?></a></li>
                    <?php endforeach; ?>
                </ul>
            </div>
        <?php endif; ?>
    </form>

    <p class="pull-right">

        <?php if(Route::currentRouteName() == 'nodes.type-list'): ?>
            <a href="<?php echo route('nodes.list', array($collection->application_id, $collection->id)); ?>" class="btn"><i class="icon-list"></i> Node List</a>
        <?php endif; ?>

        <?php /*<?php if(Config::get('core.features.hierarchy')): ?>*/ ?>
            <?php /*<a href="<?php echo route('nodes.hierarchy', array($collection->application_id, $collection->id)); ?>" class="btn"><i class="icon-sitemap"></i> Hierarchy</a>*/ ?>
        <?php /*<?php endif; ?>*/ ?>

        <?php if(count(NodeType::forSelect($collection, false, 'create'))): ?>
            <a href="<?php echo route('nodes.create', array($collection->application_id, $collection->id)); ?>" class="btn" id="openNodeModal"><i class="icon-plus"></i> New Domain</a>
        <?php endif; ?>
    </p>

    <table class="table">

        <thead>
            <tr>
                <th class="cursor"><a href="<?php echo orderColumn('id'); ?>">ID</a></th>
                <th class="cursor"><a href="<?php echo orderColumn('title'); ?>">Title</a></th>
                <th class="cursor"><a href="<?php echo orderColumn('node_type'); ?>">Node Type</a></th>
                <th class="cursor"><a href="<?php echo orderColumn('status'); ?>">Status</a></th>
                <th class="cursor">Owner</th>
                <th class="cursor"><a href="<?php echo orderColumn('created_at'); ?>">Created</a></th>
                <th width="150"></th>
            </tr>
        </thead>

        <tbody>
            <?php foreach($nodes as $node): ?>
                <?php echo $__env->make('nodes.list-row', compact('node', 'nodeTypes'), array_except(get_defined_vars(), array('__data', '__path')))->render(); ?>
            <?php endforeach; ?>
        </tbody>
    </table>

    <div style="text-align: center">
        <?php echo $nodes->appends( array('filter' => Input::get('filter'), 'column' => Input::get('column'), 'sort' => Input::get('sort')) )->links(); ?>
    </div>

    <div class="modal hide fade" id="addNodeModal">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h3>Add Node</h3>
        </div>
        <div class="modal-body">
            <p>Please select a node type to add.</p>
            <?php echo Form::select('node_type', NodeType::forSelect($collection, false, 'create'), null, array('id' => 'node_type_select', 'class' => 'select2')); ?>

            <div id="addNodeModalExisting" style="display: none;">
                <?php echo Form::hidden('existing_node', null, array('id' => 'existing_node_select')); ?>

            </div>
        </div>
        <div class="modal-footer">
            <a href="#" data-dismiss="modal" class="btn">Close</a>
            <a href="#" class="btn btn-primary" id="addNodeConfirm">Add Node</a>
        </div>
    </div>

    <div class="modal hide fade" id="nodePublishModal">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h3>Are you sure?</h3>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to publish this revision?</p>
            <div class="well">
                <p><strong>This will also&hellip;</strong></p>
                <ul>
                    <li>Make the newly published revision immediately available on the application.</li>
                    <li>Retire the current published revision if there is one.</li>
                </ul>
            </div>
        </div>
        <div class="modal-footer">
            <a href="#" data-dismiss="modal" class="btn">Close</a>
            <a href="#" class="btn btn-primary" id="publishNodeConfirm">Yes, I'm Sure</a>
        </div>
    </div>

    <div class="modal hide fade" id="deleteNodeModal">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h3>Are you sure?</h3>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to delete this node?</p>
        </div>
        <div class="modal-footer">
            <a href="#" data-dismiss="modal" class="btn">Close</a>
            <a href="#" class="btn btn-primary" id="do">Yes, I'm Sure</a>
        </div>
    </div>

    <script>
        $(document).ready( function() {
            var application_id;
            var collection_id;
            var node_id;
            var branch_id;
            var latest_revision;

            $('.modal-toggle').click( function(e) {
                e.preventDefault();

                if ( $(this).attr('href') == "#deleteNodeModal" ) {
                    application_id = $(this).attr('data-application-id');
                    collection_id = $(this).attr('data-collection-id');
                    node_id = $(this).attr('data-node-id');
                    branch_id = $(this).attr('data-branch-id');
                    latest_revision = $(this).attr('data-latest-revision');

                    $('#deleteNodeModal').modal('show');
                }
            });

            $("#deleteNodeModal").on('shown', function() {
                 if ( branch_id === undefined ) {
                        var url = "<?php echo route('nodes.delete', array('appId', 'collectionId', 'nodeId')); ?>";

                        $("#do").one('click', function(e) {
                            e.preventDefault();
                            $.ajax({
                                type: "POST",
                                data: 'latest_revision=' + latest_revision,
                                url: url.replace('appId', application_id).replace('collectionId', collection_id).replace('nodeId', node_id),
                                success: function() {
                                    location.reload(true);
                                }
                            });
                        });
                    } else {
                        // There is a branch ID
                    }
            });
        });
    </script>

<?php $__env->stopSection(); ?>

<?php echo $__env->make('layouts.master', array_except(get_defined_vars(), array('__data', '__path')))->render(); ?>