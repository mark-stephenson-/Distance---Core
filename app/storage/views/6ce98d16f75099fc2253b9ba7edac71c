<?php $__env->startSection('header'); ?>
    <?php if($user->exists): ?>
        <h1>Editing User</h1>
    <?php else: ?>
        <h1>New User</h1>
    <?php endif; ?>
<?php $__env->stopSection(); ?>

<?php $__env->startSection('body'); ?>
    
    <?php echo formModel($user, 'users', array('autocomplete' => 'off'), false); ?>


    <ul class="nav nav-tabs">
        <li class="active"><a href="#info" data-toggle="tab">User Info</a></li>

        <?php if( $user->exists ): ?>
            <li><a href="#groups" data-toggle="tab">Groups</a></li>
            <li><a href="#permissions" data-toggle="tab">Trust, Hospitals and Wards Permissions</a></li>
        <?php endif; ?>

    </ul>

    <div class="tab-content">
        <div class="tab-pane active" id="info">

            <?php if(Sentry::getUser()->isSuperUser()): ?>
                <div class="control-group">
                    <?php echo Form::label('super_admin', 'Super Admin', array('class' => 'control-label')); ?>

                    <div class="controls">
                        <?php echo Form::checkbox('super_admin', true, $user->isSuperUser()); ?>

                    </div>
                </div>
            <?php endif; ?>

            <div class="control-group">
                <?php echo Form::label('first_name', 'First Name', array('class' => 'control-label')); ?>

                <div class="controls">
                    <?php echo Form::text('first_name', null, array('class' => 'span11')); ?>

                </div>
            </div>

            <div class="control-group">
                <?php echo Form::label('last_name', 'Last Name', array('class' => 'control-label')); ?>

                <div class="controls">
                    <?php echo Form::text('last_name', null, array('class' => 'span11')); ?>

                </div>
            </div>

            <div class="control-group">
                <?php echo Form::label('email', 'Email Address', array('class' => 'control-label')); ?>

                <div class="controls">
                    <?php echo Form::text('email', null, array('class' => 'span11')); ?>

                </div>
            </div>

            <?php if($field_1 = Config::get('core.labels.user_field_1')): ?>
                <div class="control-group">
                    <?php echo Form::label('field_1', $field_1, array('class' => 'control-label')); ?>

                    <div class="controls">
                        <?php echo Form::text('field_1', Input::old('field_1', $user->field_1), array('class' => 'span11')); ?>

                    </div>
                </div>
            <?php endif; ?>

            <?php if($field_2 = Config::get('core.labels.user_field_2')): ?>
                <div class="control-group">
                    <?php echo Form::label('field_2', $field_2, array('class' => 'control-label')); ?>

                    <div class="controls">
                        <?php echo Form::text('field_2', Input::old('field_2', $user->field_2), array('class' => 'span11')); ?>

                    </div>
                </div>
            <?php endif; ?>

            <?php if($field_3 = Config::get('core.labels.user_field_3')): ?>
                <div class="control-group">
                    <?php echo Form::label('field_3', $field_3, array('class' => 'control-label')); ?>

                    <div class="controls">
                        <?php echo Form::text('field_3', Input::old('field_3', $user->field_3), array('class' => 'span11')); ?>

                    </div>
                </div>
            <?php endif; ?>

            <?php if($field_4 = Config::get('core.labels.user_field_4')): ?>
                <div class="control-group">
                    <?php echo Form::label('field_4', $field_4, array('class' => 'control-label')); ?>

                    <div class="controls">
                        <?php echo Form::text('field_4', Input::old('field_4', $user->field_4), array('class' => 'span11')); ?>

                    </div>
                </div>
            <?php endif; ?>

            <?php if($field_5 = Config::get('core.labels.user_field_5')): ?>
                <div class="control-group">
                    <?php echo Form::label('field_5', $field_5, array('class' => 'control-label')); ?>

                    <div class="controls">
                        <?php echo Form::text('field_5', Input::old('field_5', $user->field_5), array('class' => 'span11')); ?>

                    </div>
                </div>
            <?php endif; ?>

            <hr />

            <?php if($user->exists): ?>
                <div class="alert">
                    Only enter a password if you want to change it.
                </div>
            <?php endif; ?>

            <div class="control-group">
                <?php echo Form::label('password', 'Password', array('class' => 'control-label')); ?>

                <div class="controls">
                    <?php echo Form::password('password', null, array('class' => 'span11')); ?>

                </div>
            </div>

            <div class="control-group">
                <?php echo Form::label('password_confirmation', 'Password Confirmation', array('class' => 'control-label')); ?>

                <div class="controls">
                    <?php echo Form::password('password_confirmation', null, array('class' => 'span11')); ?>

                </div>
            </div> 

        </div>

        <?php if( $user->exists ): ?>
            <div class="tab-pane" id="groups">
                <?php echo $__env->make('users.groups', array_except(get_defined_vars(), array('__data', '__path')))->render(); ?>
            </div>

            <div class="tab-pane" id="permissions">
                <?php if ( ! ($trusts->isEmpty())): ?>
                    <ul class="unstyled">
                        <?php foreach($trusts as $trust): ?>
                            <li>
                                <div class="checkbox">
                                    <label>
                                        <input type="checkbox" class="nodes-checkbox" data-node-checkbox="<?php echo $trust->node_id; ?>" name="node_ids[]" value="<?php echo $trust->node_id; ?>" <?php echo in_array($trust->node_id, $user->accessible_nodes) ? 'checked' : ''; ?>><?php echo $trust->name; ?>

                                        <a data-toggle="collapse" class="arrow-link" href="#collapse_hospitals_<?php echo $trust->node_id; ?>" aria-expanded="false" aria-controls="collapse_hospitals_<?php echo $trust->node_id; ?>"><i class="icon-caret-right"></i></a>
                                    </label>
                                </div>
                                <?php if ( ! ($trust->hospitals->isEmpty())): ?>
                                    <ul class="collapse" id="collapse_hospitals_<?php echo $trust->node_id; ?>">
                                        <?php foreach($trust->hospitals as $hospital): ?>
                                            <li>
                                                <div class="checkbox">
                                                    <label>
                                                        <input type="checkbox" class="nodes-checkbox" data-node-checkbox="<?php echo $hospital->node_id; ?>" name="node_ids[]" data-parent-node="<?php echo $trust->node_id; ?>" value="<?php echo $hospital->node_id; ?>" <?php echo in_array($hospital->node_id, $user->accessible_nodes) ? 'checked' : ''; ?>><?php echo $hospital->name; ?>

                                                        <?php if ( ! ($hospital->wards->isEmpty())): ?>
                                                            <a data-toggle="collapse" class="arrow-link" href="#collapse_wards_<?php echo $hospital->node_id; ?>" aria-expanded="false" aria-controls="collapse_wards_<?php echo $hospital->node_id; ?>"><i class="icon-caret-right"></i></a>
                                                        <?php endif; ?>
                                                    </label>
                                                </div>
                                                <?php if ( ! ($hospital->wards->isEmpty())): ?>
                                                    <ul class="collapse" id="collapse_wards_<?php echo $hospital->node_id; ?>">
                                                        <?php foreach($hospital->wards as $ward): ?>
                                                            <li>
                                                                <div class="checkbox">
                                                                    <label>
                                                                        <input type="checkbox" class="nodes-checkbox" data-node-checkbox="<?php echo $ward->node_id; ?>" name="node_ids[]" data-parent-node="<?php echo $hospital->node_id; ?>" value="<?php echo $ward->node_id; ?>" <?php echo in_array($ward->node_id, $user->accessible_nodes) ? 'checked' : ''; ?>><?php echo $ward->name; ?>

                                                                    </label>
                                                                </div>
                                                            </li>
                                                        <?php endforeach; ?>
                                                    </ul>
                                                <?php endif; ?>
                                            </li>
                                        <?php endforeach; ?>
                                    </ul>
                                <?php endif; ?>
                            </li>
                        <?php endforeach; ?>
                    </ul>
                <?php endif; ?>
            </div>
        <?php endif; ?>

    </div>   

    <div class="form-actions">
        <?php if($user->exists): ?>
            <input type="submit" class="btn btn-primary" value="Save changes" />
        <?php else: ?>
            <input type="submit" class="btn btn-primary" value="Create User" />
        <?php endif; ?>
    </div>

    <?php echo Form::close(); ?>


    <script>
        $('document').ready(function() {
            // init the collapse elements
            $('.collapse').collapse({toggle: false});

            // make sure that if a child element is checked, the parent gets checked as well
            $('.nodes-checkbox').on('change', function () {
                var $sibblings_list = $(this).closest('ul').children('li');
                var $parent_checkbox = $('#permissions').find('[data-node-checkbox="' + $(this).data('parent-node') + '"]');

                // filter through the parent children elem and get the checked ones
                var checked_sibblings = $sibblings_list.filter(function(key, item) {
                    return $(item).find('.nodes-checkbox').prop('checked');
                });

                // check/uncheck parent checkboxes all the way up to root
                if(checked_sibblings.length) {
                    $parent_checkbox.prop('checked', true);
                } else {
                    $parent_checkbox.prop('checked', false);
                }
                $parent_checkbox.trigger('change');
            });

            $('.arrow-link').click(function () {
                var $self = $(this)
                setTimeout(function() {
                    if($self.hasClass('collapsed')) {
                        $self.children('i').removeClass('icon-caret-down').addClass('icon-caret-right');
                    } else {
                        $self.children('i').removeClass('icon-caret-right').addClass('icon-caret-down');
                    }

                }, 50)
            })
        });
    </script>
<?php $__env->stopSection(); ?>

<?php echo $__env->make('layouts.master', array_except(get_defined_vars(), array('__data', '__path')))->render(); ?>